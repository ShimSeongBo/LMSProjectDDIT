<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.PaymentMapper">

	<!-- 등록금 리스트 -->
	<select id="collegeFeeList" resultType="department">
		SELECT
			DEP_NM
			, COL_NM
			, COL_FEE
		FROM DEPARTMENT D
			, COLLEGE C
		WHERE C.COL_CD = D.COL_CD
		AND COL_FEE IS NOT NULL
		ORDER BY DEP_CD
	</select>
	
	<!-- 관리자의 등록금 고지 조회 -->
	<select id="adminBillList" resultType="payment">
		SELECT
		    C.COL_NM
		    , D.DEP_NM
		    , P.STU_NO
		    , S.STU_YR
		    , P.PAY_SEM
		    , S.STU_NM
		    , (SELECT  C.COMD_NM FROM COMMON_DETAIL C WHERE C.COMD_CD = P.PAY_YN) PAY_YN
		FROM    COLLEGE C, DEPARTMENT D, PAYMENT P, STUDENT S
		WHERE   S.STU_NO = P.STU_NO
		AND     D.DEP_CD = S.DEP_CD
		AND     C.COL_CD = D.COL_CD
		AND     PAY_YN = 'PAY001'
	</select>
	
	<select id="adminBillCount" resultType="int">
		SELECT COUNT(PAY_YN)
		FROM PAYMENT
		WHERE PAY_YN = 'PAY001'
	</select>
	
	<!-- 관리자의 등록금 납부 조회 -->
	<select id="adminPaymentList" resultType="payment">
		SELECT
		    C.COL_NM
		    , D.DEP_NM
		    , P.STU_NO
		    , S.STU_YR
		    , P.PAY_SEM
		    , S.STU_NM
		    , C.COL_FEE
		    , SH.SCLH_AMT
		    , P.PAY_AMT
		    , P.PAY_DT
		    , (SELECT  C.COMD_NM FROM COMMON_DETAIL C WHERE C.COMD_CD = P.PAY_YN) PAY_YN
		FROM    COLLEGE C, DEPARTMENT D, PAYMENT P, STUDENT S, SCL_HISTORY SH
		WHERE   S.STU_NO = P.STU_NO
		AND     D.DEP_CD = S.DEP_CD
		AND     C.COL_CD = D.COL_CD
		AND     S.STU_NO = SH.STU_NO (+)
	</select>
	
	<!-- 올해 납부되어야 할 등록금 총액과 현재 납부된 등록금 총액 -->
	<select id="sumFee" resultType="payment">
		SELECT
		(SELECT SUM(C.COL_FEE) FROM STUDENT A INNER JOIN DEPARTMENT B ON A.DEP_CD = B.DEP_CD INNER JOIN COLLEGE C ON C.COL_CD = B.COL_CD
		WHERE STU_RGB = 'RCD002') AS PAY_SUMFEE,
		(
		SELECT SUM(PAY_AMT)
		FROM PAYMENT
		WHERE PAY_YN = 'PAY002'
		) AS PAY_SUMAMT
		FROM DUAL
	</select>
	
	<!-- 학생 등록금 납부내역 리스트 -->
	<select id="stuPaymentList" resultType="payment">
	<![CDATA[
		SELECT DISTINCT
		    TO_NUMBER(TO_CHAR(SYSDATE,'YYYY')) + 1 ||'년'|| CASE WHEN TO_NUMBER(TO_CHAR(SYSDATE,'MM'))>=9 AND
    		TO_NUMBER(TO_CHAR(SYSDATE,'MM'))>= 2 THEN 1 ELSE 2 END ||'학기' AS PAY_DATE
		    , C.COL_FEE
		    , SH.SCLH_AMT
		    , (C.COL_FEE) - (SH.SCLH_AMT) PAY_AMT
		    , (SELECT  C.COMD_NM FROM COMMON_DETAIL C WHERE C.COMD_CD = P.PAY_YN) PAY_YN
		FROM STUDENT S, PAYMENT P, DEPARTMENT D, COLLEGE C, SCL_HISTORY SH
		WHERE   P.STU_NO = S.STU_NO
		AND     SH.STU_NO (+) = S.STU_NO
		AND     S.DEP_CD = D.DEP_CD
		AND     D.COL_CD = C.COL_CD
		AND		P.STU_NO = #{stuNo}
	]]>
	</select>
	
</mapper>







